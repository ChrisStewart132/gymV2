<!-- gymV2 app
    gym exercise app using data scraped from the weight training guide website
    
HOME
    exercises are loaded from local files,
    exercises can be filtered by equipment, target muscle, synergist muscles, and force (push vs pull)
    exercises include sets completed 
    number of exercises loaded/visible (TODO)
    name/title filter (TODO)
    css adaptive sizing/layout (mobile) (TODO)
    reset sets btn(TODO)
USER 
    exercises can be saved (with a visual cue i.e css color scheme) to local storage and viewed on a user page
    exercises can have multiple notes saved (to local sotrage) and attached to their block 
    user mode filtering 
    ability to save/load a user.json for use between devices
    LOCK USER MODE preventing save/unsave 
    custom categorization of exercises + filter (e.g. monday, wed, fri enum) (TODO)

long range possibilities:
    save exercises with meta data and date worked with sets reps...
        graph page to visualize muscle groups worked etc
    improve scraped data quality (filtering)
    improve filtering
    add exercises
    pagination depending on performance
    phone/mobile device css styling
    online user/password/saved exercise.json / db entries
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymV2</title>
    <style>
        * {
            border: 0px solid rgb(16, 16, 16);
            color: white;  
            background-color: black;
            text-align: center;
            margin: 0px;
            vertical-align: middle;
            font-family: Lucida Console;
            font-size: xx-large;
        }
        body {
            background-color: black;
            overflow: auto; 
        }
        .container {
            border: 1px solid rgb(16, 16, 16);
            margin-bottom: 150px;
        }

        h1{padding: 3px;}
        .exercise {
            padding: 20px;
            background-color: rgb(22, 22, 22);
            display: inline-block;
            margin: 10px;
            border-radius: 12px;
            max-width: 540px;
        }
        .exercise:hover{
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        .saved {
            background-color: rgba(0, 255, 0, 1);
        }
        .hidden{
            display: none;
        }
        p, span{ 
            padding: 2px;
            font-size: medium;
        }
        .tag {
            border: 1px solid gray;
            padding: 1px;
            margin: 2px;
            font-size: smaller;
        }
        #details > p {
            text-align: left;
        }
        img {
            width: auto;
            height: 360px;
            max-width: 540px;
        }
        select:hover{
            color:black;
            background-color: white;
        }
        select{
            background-color: rgb(33, 33, 33);
            color: white;
            width: 200px;
        }
        input, select, .btn{
            min-height: 50px;
            min-width: 100px;
            margin-right: 20px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        input:hover{
            background-color: white;
            color: black;
        }
        .btn{
            padding: 20px;
            border: 1px solid white;
        }
    </style>
</head>
<body>
    <navbar>
        <label for="equipment">equipment:</label>
        <select name="equipment" id="equipment">
            <option value="empty"></option>
        </select> 

        <label for="TargetMuscleFilter">target muscle:</label>
        <select name="TargetMuscleFilter" id="TargetMuscleFilter">
            <option value="empty"></option>
        </select> 

        <label for="SynergistMuscleFilter">synergist muscle:</label>
        <select name="SynergistMuscleFilter" id="SynergistMuscleFilter">
            <option value="empty"></option>
        </select> 

        <label for="ForceSelection">force:</label>
        <select name="ForceSelection" id="ForceSelection">
            <option value="empty"></option>
        </select> 
        <input class="btn" type="submit" value="APPLY FILTER" onclick="applyFilter()">
        <input class="btn" type="submit" id="userMode" onclick="userMode(this)" value="USER MODE">
        <input class="btn" type="file" id="fileInput" accept=".json">
        <input class="btn" type="submit" onclick="save_user()" value="SAVE USER">
        <input class="btn" type="submit" onclick="reset()" value="RESET USER">
        <input class="btn" type="submit" onclick="lock_user(this)" value="UNLOCK" id="userLock">
    </navbar>

    <div class="container">
        <!-- template exercise block to be duplicated -->
        <div class="exercise" onclick="selectExercise(this, event)">
            <h1 id="name">NAME</h1>
            <img src="assets/data/exercises/90-degree crunch on bench.webp"><br>
            <div id="details">
                <p id="TargetMuscle" class="hidden">Target muscle: </p>
                <p id="Synergists" class="hidden">Synergists: </p>
                <p id="Mechanics" class="hidden">Mechanics: </p>
                <p id="Force" class="hidden">Force: </p>
            </div>
            <div id="tags" class="hidden">
                <span>tag0</span>
            </div>
            <br>
            <div>
                <input class="btn" type="submit" value="--" onclick="decrementExerciseSetsCompleted(this)">
                <input id="setsCompleted" type="number" value="0" min="0" style="width:40px;">
                <input class="btn" type="submit" value="++" onclick="incrementExerciseSetsCompleted(this)">
                <div style="text-align: right;">
                    <input style="width:94%; height:80px; margin-left: 3%;" type="text" value="" id="noteInput">
                    <input class="btn" type="submit" value="ADD NOTE" onclick="addNote(this)">
                </div>
            </div>
            <div id="notes">
                <p class="hidden" style="font-size: xx-large;">example note</p>
            </div>
        </div>
    </div>


    <script>
        const CONTAINER = document.querySelector(`.container`);
        const FILE_INPUT = document.getElementById('fileInput');
        var USER_LOCKED = document.getElementById('userLock').value === "UNLOCK";
        load_filters();
        load_exercises();

        function lock_user(btn_element){
            if(btn_element.value === "LOCK"){
                btn_element.value = "UNLOCK"
                USER_LOCKED = true
            }else{
                btn_element.value = "LOCK"
                USER_LOCKED = false
            }
        }
        function save_user(){
            const user_obj = {}
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i); // Get the key at index i
                const value = localStorage.getItem(key); // Get the value associated with the key
                user_obj[key] = value;
            }
            _downloadObjectAsJson(user_obj, "user.json")
        }
        function _downloadObjectAsJson(object, filename) {
            // Convert the object to a JSON string
            const jsonString = JSON.stringify(object, null, 2);   
            // Create a Blob object from the JSON string
            const blob = new Blob([jsonString], { type: 'application/json' });
            // Create a URL for the Blob object
            const url = URL.createObjectURL(blob);
            // Create a link element
            const link = document.createElement('a');
            // Set the href attribute of the link to the URL of the Blob object
            link.href = url;
            // Set the download attribute of the link to the desired filename
            link.download = filename;
            // Simulate a click on the link to trigger the download
            link.click();
            // Clean up by revoking the URL object
            URL.revokeObjectURL(url);
        }

        // Add an event listener to handle file selection
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0]; // Get the selected file
            if (!file) return; // If no file selected, exit
            const reader = new FileReader(); // Create a FileReader object
            reader.onload = function(event) {
                if(!confirm("load user data?")){
                    return;
                }
                const fileContent = event.target.result; // Get the file content
                const obj = JSON.parse(fileContent);
                for(const key in obj){
                    localStorage.setItem(key, obj[key])
                }
                location.reload()
            };
            reader.readAsText(file); // Read the file as text
        });

        function addNote(btn_element){
            const text_element = btn_element.parentElement.querySelector(`#noteInput`)
            const exercise_element = btn_element.parentElement.parentElement.parentElement
            const notes_element = exercise_element.querySelector(`#notes`)
            const template = notes_element.children[0]

            const note = template.cloneNode(true)
            note.textContent = text_element.value
            text_element.value = ""
            note.classList.remove(`hidden`)
            notes_element.appendChild(note)
            _saveNote(exercise_element, note)
        }
        function _load_exercise_notes_obj(exercise_element){
            const key = exercise_element.querySelector(`#name`).textContent + "_notes"
            let obj = {"notes":[]}
            if(localStorage.getItem(key) !== null){
                obj = JSON.parse(localStorage.getItem(key))
            }
            return obj
        }
        function _saveNote(exercise_element, note_element){
            const obj = _load_exercise_notes_obj(exercise_element)
            obj.notes.push(note_element.textContent)
            const key = exercise_element.querySelector(`#name`).textContent + "_notes"
            localStorage.setItem(key, JSON.stringify(obj))
        }
        function _unsaveNote(exercise_element, note_element){
            // TODO
        }

        function incrementExerciseSetsCompleted(element){
            const parent_element = element.parentElement
            const sets_completed_element = parent_element.querySelector(`#setsCompleted`)
            sets_completed_element.value = parseInt(sets_completed_element.value)+1
        }
        function decrementExerciseSetsCompleted(element){
            const parent_element = element.parentElement
            const sets_completed_element = parent_element.querySelector(`#setsCompleted`)
            const n = parseInt(sets_completed_element.value)
            if(n > 0)
                sets_completed_element.value = n-1
        }

        function userMode(element){
            if(element.classList.contains(`saved`)){
                element.classList.remove(`saved`)
                applyFilter()
                return;
            }

            element.classList.add(`saved`)
            for(const exercise of CONTAINER.children){
                const key = exercise.querySelector(`#name`).textContent
                if(localStorage.getItem(key) !== "1"){
                    exercise.classList.add(`hidden`)
                }else{
                    exercise.classList.remove(`hidden`)
                }
            }
            applyFilter()
        }

        function reset(){
            if(!confirm("Are you sure?"))
                return;
            localStorage.clear()
            for(const exercise of CONTAINER.children){
                exercise.classList.remove(`saved`)
                exercise.classList.remove(`hidden`)
                const notes_element = exercise.querySelector(`#notes`)
                for(let i = notes_element.childElementCount-1; i > 0; i--){
                    notes_element.removeChild(notes_element.children[i])
                }
            }
        }

        function selectExercise(exercise_element, event){
            if(event.target.type === "submit" || event.target.type === "text" || USER_LOCKED)
                return
            if(exercise_element.classList.contains(`saved`)){
                exercise_element.classList.remove(`saved`)
                _unsaveExercise(exercise_element)
            } else {
                exercise_element.classList.add(`saved`)
                _saveExercise(exercise_element)
            }
        }
        function _saveExercise(exercise_element){
            if(USER_LOCKED)
                return
            const key = exercise_element.querySelector(`#name`).textContent
            const value = "1"
            localStorage.setItem(key, value)
        }
        function _unsaveExercise(exercise_element){
            if(USER_LOCKED)
                return
            const key = exercise_element.querySelector(`#name`).textContent
            localStorage.removeItem(key)
        }


        async function load_filters(){
            load_equipment_filter()
            load_target_muscle_filter()
            load_synergist_muscle_filter()
            load_forces_filter()
        }
        function _create_filter_option_element(text, parent){
            const option = document.createElement(`option`)
            option.textContent = text;
            option.value = text;
            parent.appendChild(option);
        }
        async function load_forces_filter(){
            const obj = await fetch(`assets/data/forces.json`).then(r=>r.json());
            const parent = document.getElementById(`ForceSelection`)
            obj["forces"].sort()
            obj["forces"].forEach((text) => {
                _create_filter_option_element(text, parent)
            })
        }
        async function load_equipment_filter(){
            const obj = await fetch(`assets/data/equipment_tags.json`).then(r=>r.json());
            const parent = document.getElementById(`equipment`)
            obj["equipment"].sort()
            obj["equipment"].forEach((text) => {
                _create_filter_option_element(text, parent)
            })
        }
        async function load_synergist_muscle_filter(){
            const obj = await fetch(`assets/data/synergists.json`).then(r=>r.json());
            const parent = document.getElementById(`SynergistMuscleFilter`)
            obj["synergists"].sort()
            obj["synergists"].forEach((text) => {
                _create_filter_option_element(text, parent)
            })
        }
        async function load_target_muscle_filter(){
            const obj = await fetch(`assets/data/target_muscles.json`).then(r=>r.json());
            const parent = document.getElementById(`TargetMuscleFilter`)
            obj["target muscles"].sort()
            obj["target muscles"].forEach((text) => {
                _create_filter_option_element(text, parent)
            })
        }


        async function load_exercises(){
            names_obj = await fetch("assets/data/names.json").then(response => response.json());
            names_obj.names.forEach((name, index, arr) => {
                _load_exercise(name);
            });
            CONTAINER.children[0].classList.add(`hidden`)
        }
        async function _load_exercise(name){
            const exercise_element = await _create_exercise_element(name);
            const key = name
            if(localStorage.getItem(key) === "1"){
                exercise_element.classList.add(`saved`)
            }

            const notes_obj = _load_exercise_notes_obj(exercise_element)
            const notes_element = exercise_element.querySelector(`#notes`)
            const template = notes_element.children[0]
            for(const note_str of notes_obj.notes){
                const note_element = template.cloneNode(true)
                note_element.textContent = note_str
                note_element.classList.remove(`hidden`)
                notes_element.appendChild(note_element)
            }

            CONTAINER.appendChild(exercise_element);
        }
        async function _create_exercise_element(name){
            const template = CONTAINER.querySelector(`.exercise`);
            let exercise_element = template.cloneNode(true);
            exercise_element.querySelector('#name').textContent = name; 

            const metadata = await fetch(`assets/data/exercises/${name}.json`).then(r => r.json());
            //console.log(metadata)
            exercise_element.querySelector('img').src = `assets/data/exercises/${name}.webp`

            exercise_element.querySelector('#TargetMuscle').textContent += metadata[`Target muscle`]
            exercise_element.querySelector('#Synergists').textContent += metadata[`Synergists`]
            exercise_element.querySelector('#Mechanics').textContent += metadata[`Mechanics`]
            exercise_element.querySelector('#Force').textContent += metadata[`Force`]

            const tags = exercise_element.querySelector('#tags');
            for(let i = tags.childElementCount-1; i > -1; i--){
                tags.removeChild(tags.children[i])
            }
            metadata.tags.forEach((tag => {
                const element = document.createElement(`span`);
                element.classList.add(`tag`)
                element.textContent = tag;
                tags.appendChild(element);
            }))
            return exercise_element;
        }

        async function applyFilter(){
            const userModeElement = document.getElementById(`userMode`)
            if(!userModeElement.classList.contains(`saved`)){// not in user mode
                await _resetFilter();
            }else{// user mode
                Array.from(CONTAINER.children).forEach(e => {
                    const key = e.querySelector(`#name`).textContent
                    if(localStorage.getItem(key) === "1")
                        e.classList.remove(`hidden`)
                })
            }
            await _applyEquipmentFilter();
            await _applyForceFilter();
            await _applyTargetFilter();
            await _applySynergistFilter();     
        }
        async function _resetFilter(){
            Array.from(CONTAINER.children).forEach(e => e.classList.remove(`hidden`))
        }
        async function _applyEquipmentFilter(){
            const filter = document.getElementById("equipment")
            if(filter.value != 'empty'){
                Array.from(CONTAINER.children).forEach((e,i)=>{
                    if(e.classList.contains(`hidden`)){
                        return;   
                    }
                    const tags = e.querySelector(`#tags`)
                    const arr = Array.from(tags.children, e => e.textContent)
                    if(!arr.includes(filter.value)){
                        e.classList.add(`hidden`)
                    }
                })
            }
        }
        async function _applyForceFilter(){
            const filter = document.getElementById("ForceSelection")
            if(filter.value != 'empty'){
                Array.from(CONTAINER.children).forEach((e,i)=>{
                    if(e.classList.contains(`hidden`)){
                        return;   
                    }
                    const str = e.querySelector(`#Force`).textContent
                    if(!str.includes(filter.value)){
                        e.classList.add(`hidden`)
                    }
                })
            }
        }
        async function _applyTargetFilter(){
            const filter = document.getElementById("TargetMuscleFilter")
            if(filter.value != 'empty'){
                Array.from(CONTAINER.children).forEach((e,i)=>{
                    if(e.classList.contains(`hidden`)){
                        return;   
                    }
                    const str = e.querySelector(`#TargetMuscle`).textContent
                    if(!str.includes(filter.value)){
                        e.classList.add(`hidden`)
                    }
                })
            }
        }
        async function _applySynergistFilter(){
            const filter = document.getElementById("SynergistMuscleFilter")
            if(filter.value != 'empty'){
                Array.from(CONTAINER.children).forEach((e,i)=>{
                    if(e.classList.contains(`hidden`)){
                        return;   
                    }
                    const str = e.querySelector(`#Synergists`).textContent
                    if(!str.includes(filter.value)){
                        e.classList.add(`hidden`)
                    }
                })
            }
        }

    </script>
</body>
</html>
